{{- $secrets := printf "%s-secrets" (include "kharseka.fullname" .) -}}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: auth-service
spec:
  replicas: {{ .Values.services.auth.replicas }}
  selector: { matchLabels: { app: auth-service } }
  template:
    metadata: { labels: { app: auth-service } }
    spec:
      initContainers:
      - name: wait-for-postgres
        image: postgres:16-alpine
        command: ["sh","-c"]
        args:
          - >-
            until pg_isready -h postgres -p 5432 -d market -U postgres; do echo waiting for postgres; sleep 2; done
      containers:
      - name: auth
        image: {{ .Values.services.auth.image }}:{{ .Values.services.auth.tag }}
        imagePullPolicy: {{ .Values.global.imagePullPolicy }}
        envFrom: [{ secretRef: { name: {{ $secrets | quote }} } }]
        ports: [{ containerPort: 3001 }]
        resources:
{{ toYaml .Values.services.auth.resources | indent 10 }}
        readinessProbe:
          httpGet: { path: /healthz, port: 3001 }
          initialDelaySeconds: 5
          periodSeconds: 10
        livenessProbe:
          httpGet: { path: /healthz, port: 3001 }
          initialDelaySeconds: 10
          periodSeconds: 20
---
apiVersion: v1
kind: Service
metadata:
  name: auth-service
spec:
  selector: { app: auth-service }
  ports: [{ port: 3001, targetPort: 3001 }]
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: listings-service
spec:
  replicas: {{ .Values.services.listings.replicas }}
  selector: { matchLabels: { app: listings-service } }
  template:
    metadata: { labels: { app: listings-service } }
    spec:
      initContainers:
      - name: wait-for-postgres
        image: postgres:16-alpine
        command: ["sh","-c"]
        args:
          - >-
            until pg_isready -h postgres -p 5432 -d market -U postgres; do echo waiting for postgres; sleep 2; done
      containers:
      - name: listings
        image: {{ .Values.services.listings.image }}:{{ .Values.services.listings.tag }}
        imagePullPolicy: {{ .Values.global.imagePullPolicy }}
        envFrom: [{ secretRef: { name: {{ $secrets | quote }} } }]
        ports: [{ containerPort: 3002 }]
        resources:
{{ toYaml .Values.services.listings.resources | indent 10 }}
        readinessProbe:
          httpGet: { path: /healthz, port: 3002 }
          initialDelaySeconds: 5
          periodSeconds: 10
        livenessProbe:
          httpGet: { path: /healthz, port: 3002 }
          initialDelaySeconds: 10
          periodSeconds: 20
---
apiVersion: v1
kind: Service
metadata:
  name: listings-service
spec:
  selector: { app: listings-service }
  ports: [{ port: 3002, targetPort: 3002 }]
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: favorites-service
spec:
  replicas: {{ .Values.services.favorites.replicas }}
  selector: { matchLabels: { app: favorites-service } }
  template:
    metadata: { labels: { app: favorites-service } }
    spec:
      initContainers:
      - name: wait-for-postgres
        image: postgres:16-alpine
        command: ["sh","-c"]
        args:
          - >-
            until pg_isready -h postgres -p 5432 -d market -U postgres; do echo waiting for postgres; sleep 2; done
      containers:
      - name: favorites
        image: {{ .Values.services.favorites.image }}:{{ .Values.services.favorites.tag }}
        imagePullPolicy: {{ .Values.global.imagePullPolicy }}
        envFrom: [{ secretRef: { name: {{ $secrets | quote }} } }]
        ports: [{ containerPort: 3003 }]
        resources:
{{ toYaml .Values.services.favorites.resources | indent 10 }}
        readinessProbe:
          httpGet: { path: /healthz, port: 3003 }
          initialDelaySeconds: 5
          periodSeconds: 10
        livenessProbe:
          httpGet: { path: /healthz, port: 3003 }
          initialDelaySeconds: 10
          periodSeconds: 20
---
apiVersion: v1
kind: Service
metadata:
  name: favorites-service
spec:
  selector: { app: favorites-service }
  ports: [{ port: 3003, targetPort: 3003 }]
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: media-service
spec:
  replicas: {{ .Values.services.media.replicas }}
  selector: { matchLabels: { app: media-service } }
  template:
    metadata: { labels: { app: media-service } }
    spec:
      containers:
      - name: media
        image: {{ .Values.services.media.image }}:{{ .Values.services.media.tag }}
        imagePullPolicy: {{ .Values.global.imagePullPolicy }}
        envFrom: [{ secretRef: { name: {{ $secrets | quote }} } }]
        env:
        - name: UPLOAD_DIR
          value: /data/uploads
        ports: [{ containerPort: 3004 }]
        volumeMounts:
        - name: uploads
          mountPath: /data/uploads
        resources:
{{ toYaml .Values.services.media.resources | indent 10 }}
        readinessProbe:
          httpGet: { path: /healthz, port: 3004 }
          initialDelaySeconds: 5
          periodSeconds: 10
        livenessProbe:
          httpGet: { path: /healthz, port: 3004 }
          initialDelaySeconds: 10
          periodSeconds: 20
      volumes:
      - name: uploads
        persistentVolumeClaim:
          claimName: uploads-pvc
